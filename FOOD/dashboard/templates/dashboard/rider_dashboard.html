{% extends "dashboard/base_dashboard.html" %}

{% block title %}Rider Dashboard | ‡¶†‡ßá‡¶ï‡¶æ‡¶ì{% endblock %}
{% block page_title %}üö¥ Unified Rider Center{% endblock %}

{% block content %}

<style>
    :root {
        --card-bg: #ffffff;
        --border: #e5e7eb;
        --muted: #6b7280;
        --radius: 20px;
        --primary: #6366f1;
        --primary-grad: linear-gradient(135deg, #6366f1, #4f46e5);
        --text-color: #1e293b;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }

    .section-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--text-color);
        margin: 0;
    }

    .task-card {
        background: var(--card-bg);
        border-radius: 16px;
        padding: 1.5rem;
        margin-bottom: 1.25rem;
        border: 1px solid var(--border);
        transition: all 0.3s ease;
        position: relative;
        animation: fadeIn 0.4s ease-out forwards;
    }

    .task-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05);
        border-color: var(--primary);
    }

    .task-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1.25rem;
    }

    .task-title {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .task-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        background: #f1f5f9;
    }

    .customer-info {
        font-size: 0.85rem;
        color: var(--muted);
        margin-top: 2px;
    }

    .service-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.7rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .badge-food { background: #fee2e2; color: #ef4444; }
    .badge-mall { background: #fef9c3; color: #ca8a04; }
    .badge-parcel { background: #e0e7ff; color: #4f46e5; }
    .badge-ride { background: #dcfce7; color: #10b981; }

    .badge-status {
        padding: 0.25rem 0.6rem;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .status-info { background: #eff6ff; color: #2563eb; }

    .info-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
        margin-bottom: 1.25rem;
        background: #f8fafc;
        padding: 1rem;
        border-radius: 12px;
    }

    .info-box { display: flex; flex-direction: column; }
    .info-label {
        font-size: 0.7rem;
        color: var(--muted);
        text-transform: uppercase;
        font-weight: 600;
        margin-bottom: 4px;
    }
    .info-value { font-weight: 700; color: var(--text-color); font-size: 0.95rem; }

    .status-select {
        flex: 1;
        padding: 0.6rem 1rem;
        border-radius: 10px;
        border: 1px solid #cbd5e1;
        font-family: inherit;
        font-size: 0.9rem;
        color: #334155;
        outline: none;
        transition: border-color 0.2s;
    }
    .status-select:focus { border-color: var(--primary); }

    .unified-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0.75rem 1.5rem;
        border-radius: 12px;
        font-weight: 600;
        font-size: 0.9rem;
        transition: all 0.2s;
        cursor: pointer;
        border: none;
        gap: 8px;
        text-decoration: none;
        width: 100%;
    }
    .btn-primary {
        background: var(--primary-grad);
        color: white;
        box-shadow: 0 4px 12px rgba(99,102,241,0.2);
    }
    .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 15px rgba(99,102,241,0.3);
    }
    .btn-dark { background: #1e293b; color: white; }
    .btn-dark:hover { background: #0f172a; }

    .empty-state { text-align:center; padding:3rem 1rem; color:var(--muted); }
    .empty-icon { font-size:3rem; margin-bottom:1rem; opacity:0.5; }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* Stats grid */
    .stats-grid {
        display: flex;
        gap: 1rem;
        margin-bottom: 2rem;
        flex-wrap: wrap;
    }
    .stat-card {
        flex: 1;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.25rem 1.5rem;
        border-radius: 16px;
        background: var(--card-bg);
        border: 1px solid var(--border);
    }
    .stat-label { font-size: 0.8rem; color: var(--muted); font-weight:600; }
    .stat-value { font-size:1.25rem; font-weight:700; color: var(--text-color); }
    .stat-icon { font-size:1.5rem; padding:0.75rem; border-radius:12px; display:flex; align-items:center; justify-content:center; }
</style>

<div class="stats-grid">
    <div class="stat-card">
        <div>
            <div class="stat-label">Total Earnings</div>
            <div class="stat-value">‡ß≥{{ total_earnings|floatformat:0 }}</div>
            <div style="font-size:.75rem;color:#9ca3af;margin-top:.5rem;">
                üçî ‡ß≥{{ food_earnings|floatformat:0 }} ‚Ä¢ üõçÔ∏è ‡ß≥{{ mall_earnings|floatformat:0 }} ‚Ä¢ üì¶ ‡ß≥{{ parcel_earnings|floatformat:0 }} ‚Ä¢ üöó ‡ß≥{{ ride_earnings|floatformat:0 }}
            </div>
        </div>
        <div class="stat-icon" style="background:linear-gradient(135deg,#10b981,#059669)">üí∞</div>
    </div>

    <div class="stat-card">
        <div>
            <div class="stat-label">Active Tasks</div>
            <div class="stat-value">{{ active_tasks|length }}</div>
        </div>
        <div class="stat-icon" style="background:linear-gradient(135deg,#f59e0b,#d97706)">‚è≥</div>
    </div>

    <div class="stat-card">
        <div>
            <div class="stat-label">Total Completed</div>
            <div class="stat-value">{{ completed_count }}</div>
        </div>
        <div class="stat-icon" style="background:linear-gradient(135deg,#6366f1,#4f46e5)">‚úÖ</div>
    </div>
</div>

<div class="row">
    <!-- Active Tasks -->
    <div class="col-lg-8">
        <div class="card" style="padding:2rem;">
            <div class="section-header">
                <h3 class="section-title">üèÉ Your Active Tasks</h3>
            </div>
            {% if active_tasks %}
                {% for task in active_tasks %}
                <div class="task-card">
                    <div class="task-header">
                        <div class="task-title">
                            <div class="task-icon">{{ task.icon }}</div>
                            <div>
                                <h4 style="margin:0; font-size:1.1rem; color: var(--text-color);">{{ task.title }}</h4>
                                <div class="customer-info"><i data-lucide="user" style="width:12px;height:12px;"></i> {{ task.customer }}</div>
                            </div>
                        </div>
                        <div style="display:flex; flex-direction:column; align-items:flex-end; gap:8px;">
                            <span class="service-badge badge-{{ task.type|lower }}">{{ task.type }}</span>
                            <span class="badge-status status-info">{{ task.status }}</span>
                        </div>
                    </div>

                    <div class="info-grid">
                        <div class="info-box">
                            <div class="info-label">Order Total</div>
                            <div class="info-value">‡ß≥{{ task.total }}</div>
                        </div>
                        <div class="info-box">
                            <div class="info-label">Your Earning</div>
                            <div class="info-value" style="color:#10b981;">‡ß≥{{ task.fee|floatformat:0 }}</div>
                        </div>
                        <div class="info-box">
                            <div class="info-label">Tracking</div>
                            <div class="info-value">
                                <a href="{{ task.url }}" style="color:var(--primary); text-decoration:none; display:flex; gap:4px; align-items:center;">Details <i data-lucide="external-link" style="width:14px;height:14px;"></i></a>
                            </div>
                        </div>
                    </div>

                    <div style="display:flex; gap:12px;">
                        {% if task.type == 'food' %}
                        <form method="post" action="{% url 'update_order_status' task.id %}" style="display:flex; gap:12px; flex:1;">
                            {% csrf_token %}
                            <select name = "status" class="status-select">
                                <option value = "accepted" {% if task.raw_status == 'accepted' %}selected{% endif %}>Accepted</option>
                                <option value="preparing" {% if task.raw_status == 'preparing' %}selected{% endif %}>Preparing</option>
                                <option value="out_for_delivery" {% if task.raw_status == 'out_for_delivery' %}selected{% endif %}>Out for delivery</option>
                                <option value="delivered" {% if task.raw_status == 'delivered' %}selected{% endif %}>Delivered</option>
                            </select>
                            <button class="unified-btn btn-primary" style="width:auto; padding:0.6rem 1.5rem;">Update</button>
                        </form>
                        {% elif task.type == 'mall' %}
                        <form method="post" action="{% url 'update_mall_order_status' task.id %}" style="display:flex; gap:12px; flex:1;">
                            {% csrf_token %}
                            <select name="status" class="status-select">
                                <option value="confirmed" {% if task.raw_status == 'confirmed' %}selected{% endif %}>Confirmed</option>
                                <option value="shipped" {% if task.raw_status == 'shipped' %}selected{% endif %}>Shipped</option>
                                <option value="picked_up" {% if task.raw_status == 'picked_up' %}selected{% endif %}>Picked Up</option>
                                <option value="delivered" {% if task.raw_status == 'delivered' %}selected{% endif %}>Delivered</option>
                            </select>
                            <button class="unified-btn btn-primary" style="width:auto; padding:0.6rem 1.5rem;">Update</button>
                        </form>
                        {% elif task.type == 'parcel' %}
                            {% if task.raw_status == 'accepted' %}
                            <a href="{% url 'pickup_parcel' task.id %}" class="unified-btn btn-primary">
                                <i data-lucide="package-check" style="width:18px;height:18px;"></i> Mark Picked Up
                            </a>
                            {% elif task.raw_status == 'picked_up' %}
                            <a href="{% url 'deliver_parcel' task.id %}" class="unified-btn btn-primary">
                                <i data-lucide="check-circle" style="width:18px;height:18px;"></i> Mark Delivered
                            </a>
                            {% endif %}
                        {% elif task.type == 'ride' %}
                            {% if task.raw_status == 'accepted' %}
                            <a href="{% url 'rides:start_ride' task.id %}" class="unified-btn btn-primary">
                                <i data-lucide="play-circle" style="width:18px;height:18px;"></i> Start Ride
                            </a>
                            {% elif task.raw_status == 'in_progress' %}
                            <a href="{% url 'rides:complete_ride' task.id %}" class="unified-btn btn-primary">
                                <i data-lucide="stop-circle" style="width:18px;height:18px;"></i> End Ride
                            </a>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            {% else %}
            <div class="empty-state">
                <div class="empty-icon">üõãÔ∏è</div>
                <div>No active tasks. Time to pick one!</div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Available Tasks -->
    <div class="col-lg-4">
        <div class="card" style="padding:1.5rem;">
            <h3 class="section-title">üÜï New Opportunities</h3>
            {% if available_tasks %}
                {% for task in available_tasks %}
                <div class="task-card" style="border-style:dashed; border-width:2px;">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:1rem;">
                        <div class="task-title">
                            <div class="task-icon" style="background:#f8fafc;">{{ task.icon }}</div>
                            <div>
                                <h5 style="margin:0; font-size:1rem;">{{ task.title }}</h5>
                                <div class="customer-info">New Request</div>
                            </div>
                        </div>
                        <span class="service-badge badge-{{ task.type|lower }}">{{ task.type }}</span>
                    </div>
                    <div style="background:#f0fdf4; padding:0.75rem; border-radius:10px; margin-bottom:1.25rem; display:flex; justify-content:space-between; align-items:center;">
                        <span style="font-size:0.8rem; color:#166534; font-weight:600;">Potential Earning</span>
                        <span style="font-weight:800; color:#10b981; font-size:1.1rem;">‡ß≥{{ task.fee|floatformat:0 }}</span>
                    </div>
                    <a href="{{ task.accept_url }}" class="unified-btn btn-dark">
                        <i data-lucide="check-square" style="width:18px;height:18px;"></i> Accept Task
                    </a>
                </div>
                {% endfor %}
            {% else %}
            <div class="empty-state">
                <div class="empty-icon">üì≠</div>
                <div>Watching for new requests...</div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

{% endblock %}
